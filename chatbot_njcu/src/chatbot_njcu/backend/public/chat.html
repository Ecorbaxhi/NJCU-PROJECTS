<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Career Center Chat (local)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font: 16px/1.4 system-ui, sans-serif; max-width: 800px; margin: 40px auto; padding: 0 16px; }
    h1 { font-size: 20px; }
    #q { width: 100%; height: 90px; }
    #ask { padding: 8px 14px; }
    #ans { background:#f7f7f9; padding:12px; border-radius:8px; margin-top:12px; }
    #ans p { margin: 0 0 8px; }
    #ans ul { margin: 0 0 8px 18px; }
    .src { font-size: 12px; color:#555; margin-top:8px; }
  </style>
</head>
<body>
  <h1>Career Center Chat (local)</h1>

  <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px;">
    <button id="reload">Reload index</button>
    <span id="ver" style="font-size:12px;color:#555;"></span>
  </div>

  <textarea id="q" placeholder="Type your question..."></textarea><br />
  <button id="ask">Ask</button>

  <div id="ans"></div>

  <div id="fb" style="display:none;margin-top:8px;">
    <span style="margin-right:6px;">Was this helpful?</span>
    <button id="fb-yes" title="Yes">üëç</button>
    <button id="fb-no"  title="No">üëé</button>
    <span id="fb-msg" style="margin-left:8px;font-size:12px;color:#666;"></span>
  </div>

  <script>
    const API_BASE = window.location.origin;

    // --- State for feedback ---
    let lastQuestion = "";
    let lastAnswer   = "";
    let versionString = "";

    // -------- Simple safe Markdown renderer (bold, italic, bullets, links) --------
    function escapeHtml(s) {
      return (s || "").replace(/[&<>"']/g, c => (
        { "&":"&amp;", "<":"&lt;", ">":"&gt;", "\"":"&quot;", "'":"&#39;" }[c]
      ));
    }
    function linkify(s) {
      return s.replace(
        /(https?:\/\/[^\s<>()]+)(?=[\s<>()]|$)/g,
        (m) => `<a href="${m}" target="_blank" rel="noopener noreferrer">${m}</a>`
      );
    }
    function renderMarkdown(md) {
      let s = escapeHtml(md || "");
      s = s.replace(/`([^`]+)`/g, "<code>$1</code>");
      s = s.replace(/\*\*([^*]+)\*\*/g, "<strong>$1</strong>");
      s = s.replace(/\*([^*\n]+)\*/g, "<em>$1</em>");

      const lines = s.split(/\r?\n/);
      let out = [], inList = false;
      for (const line of lines) {
        const m = line.match(/^\s*[-*]\s+(.*)$/);
        if (m) {
          if (!inList) { out.push("<ul>"); inList = true; }
          out.push(`<li>${m[1]}</li>`);
        } else {
          if (inList) { out.push("</ul>"); inList = false; }
          out.push(line);
        }
      }
      if (inList) out.push("</ul>");
      s = out.join("\n");

      s = s.replace(/\n{2,}/g, "</p><p>");
      s = s.replace(/\n/g, "<br>");
      return linkify(`<p>${s}</p>`);
    }
    // ------------------------------------------------------------------------------

    const askBtn    = document.getElementById("ask");
    const qEl       = document.getElementById("q");
    const ansEl     = document.getElementById("ans");
    const verEl     = document.getElementById("ver");
    const reloadBtn = document.getElementById("reload");
    const fbYes = document.getElementById("fb-yes");
    const fbNo  = document.getElementById("fb-no");
    const fbMsg = document.getElementById("fb-msg");
    const fbBar = document.getElementById("fb");

    async function showVersion() {
      try {
        const r = await fetch(API_BASE + "/version");
        if (!r.ok) throw new Error("HTTP " + r.status);
        const data = await r.json();
        versionString = data.version || "";
        verEl.textContent = `Source: ${data.csv_path} ‚Ä¢ Docs: ${data.docs} ‚Ä¢ ${data.version}`;
      } catch {
        verEl.textContent = "(version unavailable)";
      }
    }

    async function ask() {
      const question = qEl.value.trim();
      if (!question) return;

      askBtn.disabled = true;
      ansEl.textContent = "Thinking‚Ä¶";
      fbBar.style.display = "none";

      try {
        const res = await fetch(API_BASE + "/query", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({ question, k: 3 })
        });
        if (!res.ok) throw new Error("HTTP " + res.status);
        const data = await res.json();

        ansEl.innerHTML =
          `<div style="font-weight:600;margin-bottom:6px;">Answer</div>` +
          renderMarkdown(data.answer) +
          (data.sources?.length
            ? `<div class="src"><strong>Top sources</strong><br>${
                data.sources.slice(0,3)
                  .map(s => `‚Ä¢ ${escapeHtml(s.metadata?.question ?? '(unknown source)')}`)
                  .join("<br>")
              }</div>` : "");

        lastQuestion = question;
        lastAnswer   = data.answer || "";
        fbMsg.textContent = "";
        fbBar.style.display = "inline-block";
      } catch (e) {
        ansEl.textContent = "Error: " + e.message;
      } finally {
        askBtn.disabled = false;
      }
    }

    async function reloadIndex() {
      reloadBtn.disabled = true;
      const was = verEl.textContent;
      verEl.textContent = "Reloading index‚Ä¶";
      try {
        const r = await fetch(API_BASE + "/reload", { method: "POST" });
        if (!r.ok) throw new Error("HTTP " + r.status);
        await showVersion();
      } catch (e) {
        verEl.textContent = "Reload failed: " + e.message;
        setTimeout(() => (verEl.textContent = was), 4000);
      } finally {
        reloadBtn.disabled = false;
      }
    }

    async function sendFeedback(helpful) {
      try {
        fbYes.disabled = fbNo.disabled = true;
        fbMsg.textContent = "Sending‚Ä¶";
        const r = await fetch(API_BASE + "/feedback", {
          method: "POST",
          headers: {"Content-Type": "application/json"},
          body: JSON.stringify({
            question: lastQuestion,
            answer:   lastAnswer,
            helpful:  helpful,
            version:  versionString
          })
        });
        if (!r.ok) throw new Error("HTTP " + r.status);
        fbMsg.textContent = "Thanks for your feedback!";
        setTimeout(() => { fbBar.style.display = "none"; }, 1500);
      } catch {
        fbMsg.textContent = "Couldn‚Äôt send feedback.";
      } finally {
        fbYes.disabled = fbNo.disabled = false;
      }
    }

    askBtn.addEventListener("click", ask);
    qEl.addEventListener("keydown", (e) => { if (e.key === "Enter" && (e.ctrlKey || e.metaKey)) ask(); });
    reloadBtn.addEventListener("click", reloadIndex);
    fbYes.addEventListener("click", () => sendFeedback(true));
    fbNo .addEventListener("click", () => sendFeedback(false));

    showVersion();
  </script>
</body>
</html>
